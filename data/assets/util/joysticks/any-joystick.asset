local propertyHelper = asset.require("../property_helper")
local joystickHelper = asset.require("./joystick_helper")

local function numItems(iTable)
  local counter = 0
  for k, v in ipairs(iTable) do
    counter = counter + 1
  end
  return counter
end

asset.onInitialize(function()
  local rawJoysticks = openspace.navigation.listAllJoysticks()
  local numJoysticks = numItems(rawJoysticks)
  local joystick = ""

  -- Remove the SpaceMouse emulator if it exists
  local joysticks = {}
  for _, joyStickName in ipairs(rawJoysticks) do
    if joyStickName == "3Dconnexion KMJ Emulator" then
      numJoysticks = numJoysticks - 1
    else
      table.insert(joysticks, joyStickName)
    end
  end

  -- Is any joysticks connected?
  if numJoysticks == 0 then
    openspace.printWarning("Could not find any connected joysticks")
    return
  end

  -- when only one joystick is connected
  if numJoysticks == 1 then
    local joyStickName = joysticks[1]
    if joyStickName ~= nil then
      joystick = joyStickName
    end
  else
    openspace.printWarning("Cannot auto detect and add several joysticks")
    return
  end

  if joystick == "" then
    openspace.printWarning("Could not find any connected joysticks")
    return
  end

  if joystick == "Wireless Controller" then
    openspace.asset.add("./util/joysticks/ps4")
  elseif joystick == "Xbox Controller" then
    openspace.asset.add("./util/joysticks/xbox")
  elseif joystick == "Wireless Xbox Controller" then
    openspace.asset.add("./util/joysticks/xbox-wireless")
  elseif joystick == "SpaceNavigator" then
    openspace.asset.add("./util/joysticks/space-mouse-compact")
  elseif joystick == "SpaceMouse Enterprise" then
    openspace.asset.add("./util/joysticks/space-mouse-enterprise")
  elseif joystick == "3Dconnexion Universal Receiver" then
    openspace.printWarning("SpaceMouse in wireless mode cannot be automatically detected and added. Please add the matching asset file manually.")
  else
    openspace.printWarning("Could not find a matching asset for joystick: " .. joystick)
  end
end)
